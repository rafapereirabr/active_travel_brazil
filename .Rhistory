setwd("R:/Dropbox/github/active_travel_brazil")
source("./R-scripts/0 LoadPackages.R")
pns2013 <- readRDS("./data/pns2013.Rds")
# Keep only important variables
#pnad2008 <- select(pnad2008, v0101,uf,v0102,v0103,v0403,v4729,v4609, v4732,v8005,v0302,v0404,v4803,v4838,v4728,v4727,v0602,v9005,v4805,v4706,v4810,v4720,v4721,v4721,v4745,v9054,v9055,v9056,v9057,v1409,v14091,v1410,v1411, v4602, v4618, v4617, upa, region, AGE,agegroup, urban, metro, DecileBR,Vcount, v1410mod,v1411mod,v9057mod,actv_commutetime30,pre_wgt)
pns2013 <- select(pns2013,
V0031,   # pnad compat_ metropolitan area
V0026,   # pnad compat_ urban
v4745,   # pnad compat_ Educational attainment
v0302,   # pnad compat_ Sex
v4727,   # pnad compat_ Metropolitan area
v1410,   # pnad compat_ Active Travel
v2032,   # pnad compat_ Car or motorcycle ownership
v4721,   # pnad Household income per capita
V0015,   # type of interview
V0001,   # state
C006,    # sex
C009,    # race
C008,    # age
VDD004,  # Educational attainment
P040,    # Active commute
P04101,  # Active commute time (hours)
P04102,  # Active commute time (minutes)
P04301, # active travel to habitual activities
P04302, # active travel time to habitual activities
P00101, # Weight
P00401, # Height
N001, # health perception
O009, # car accident
O011, # travel mode when injured
O014, # accident hindered habitual activities
O020, # any sequel and / or disability due to this traffic accident
Q002, # Ever diagnosed with hypertension
Q003, # age at diagnosis for hypertension
Q030, # Ever diagnosed with diabetes
Q031, # age at diagnosis for diabetes
Q060, # Ever diagnosed with high cholesterol
Q061,  # age at diagnosis for high cholesterol
V0025,   # person selected for long questionaire
M001,    # Type of interview
UPA_PNS, # UPA
V0024,   # Strata
V0029,   # person sample weight without calibratio
V00291,  # person sample weight with calibration
V00292,  # Population projection
V00283,  # Dominio de pos-estrato 1
V00293,  # Dominio de pos-estrato 2
A01817,  # Motorcycle ownership
A020,    # Car ownership (number of cars)
v2032,   # Vehicle in the household, compatible with PNAD
dummyVehicle,
v1410, # dummy active travel , compatible with PNAD
year, region,
AGE, agegroup, edugroup, urban, metro, vcount,
actv_commutetime30, actv_commutetime,actv_traveltimehabacts,total_actvtraveltime, physicallyactive30 # commute variables
)
pns2013dom <- readRDS("./data/pns2013dom.Rds")
# Keep only important variables
#pnad2008 <- select(pnad2008, v0101,uf,v0102,v0103,v0403,v4729,v4609, v4732,v8005,v0302,v0404,v4803,v4838,v4728,v4727,v0602,v9005,v4805,v4706,v4810,v4720,v4721,v4721,v4745,v9054,v9055,v9056,v9057,v1409,v14091,v1410,v1411, v4602, v4618, v4617, upa, region, AGE,agegroup, urban, metro, DecileBR,Vcount, v1410mod,v1411mod,v9057mod,actv_commutetime30,pre_wgt)
pns2013 <- select(pns2013,
V0031,   # pnad compat_ metropolitan area
V0026,   # pnad compat_ urban
v4745,   # pnad compat_ Educational attainment
v0302,   # pnad compat_ Sex
v4727,   # pnad compat_ Metropolitan area
v1410,   # pnad compat_ Active Travel
v2032,   # pnad compat_ Car or motorcycle ownership
v4721,   # pnad Household income per capita
V0015,   # type of interview
V0001,   # state
C006,    # sex
C009,    # race
C008,    # age
VDD004,  # Educational attainment
P040,    # Active commute
P04101,  # Active commute time (hours)
P04102,  # Active commute time (minutes)
P04301, # active travel to habitual activities
P04302, # active travel time to habitual activities
P00101, # Weight
P00401, # Height
N001, # health perception
O009, # car accident
O011, # travel mode when injured
O014, # accident hindered habitual activities
O020, # any sequel and / or disability due to this traffic accident
Q002, # Ever diagnosed with hypertension
Q003, # age at diagnosis for hypertension
Q030, # Ever diagnosed with diabetes
Q031, # age at diagnosis for diabetes
Q060, # Ever diagnosed with high cholesterol
Q061,  # age at diagnosis for high cholesterol
V0025,   # person selected for long questionaire
M001,    # Type of interview
UPA_PNS, # UPA
V0024,   # Strata
V0029,   # person sample weight without calibratio
V00291,  # person sample weight with calibration
V00292,  # Population projection
V00283,  # Dominio de pos-estrato 1
V00293,  # Dominio de pos-estrato 2
A01817,  # Motorcycle ownership
A020,    # Car ownership (number of cars)
v2032,   # Vehicle in the household, compatible with PNAD
dummyVehicle,
v1410, # dummy active travel , compatible with PNAD
year, region,
AGE, agegroup, edugroup, urban, metro, vcount,
actv_commutetime30, actv_commutetime,actv_traveltimehabacts,total_actvtraveltime, physicallyactive30 # commute variables
)
# There should be no Missings (NA) in Design Variables
# Count  missing values (NAs)
anyNA(pns2013$V00291)
length(which(is.na(pns2013$V00291)))
# Subset PNS with individuals who answered the detailed questionnaire only
# This eliminates observations with missing values in the weight variable
#PNS2013pesDet <- PNS2013pes[!(is.na(PNS2013pes$V0029))]
pns2013Det <- pns2013[M001==1, ]
#define como imputar variancia quando houver apenas um domicilio (PSU) no estrato
# set R to produce conservative standard errors instead of crashing - http://r-survey.r-forge.r-project.org/survey/exmample-lonely.html
options( survey.lonely.psu = "adjust" )  # ??survey.lonely.psu
#Cria objeto de desenho da amostra
sample.pns13 <- svydesign(data = pns2013Det,
id = ~UPA_PNS, #PSU
strata = ~V0024, #Strat
weights=~V0029, #PesoPessoa: usar peso original
nest = TRUE
)
## Agora Ã© preciso pÃ³s-estratificar:
## A definiÃ§Ã£o dos pÃ³s-estratos e os totais populacionais usados sÃ£o dados por:
## post-estratification of sample design
post_pop <- unique( subset(pns2013Det, select= c(V00293,V00292) ))
names(post_pop)<-c("V00293","Freq")
sample.pns13.pos <- postStratify(sample.pns13, ~V00293, post_pop)
#Subset design population above 18 years old
pns13.18y.design <- subset(sample.pns13.pos, C008>17)
svyquantile(~v4721, sample.pns13.pos, quantile=c(0.25,0.5,0.75), na.rm=T)
svymean(~v4721, sample.pns13.pos, na.rm=T)
summary(pns2013$v4721)
head( pns2013[is.na(v4721) )
setDT(pns2013)
head( pns2013[is.na(v4721) )
head( pns2013[is.na(v4721)] )
tail( pns2013[is.na(v4721)] )
summary(pns2013$V0015)
anyNA(pns2013$V00291)
length(which(is.na(pns2013$V00291)))
pns2013 <- readRDS("./data/pns2013.Rds")
length(which(is.na(pns2013$V0029)))
options( survey.lonely.psu = "adjust" )  # ??survey.lonely.psu
#Cria objeto de desenho da amostra
sample.pns13 <- svydesign(data = pns2013,
id = ~UPA_PNS, #PSU
strata = ~V0024, #Strat
weights=~V0029, #PesoPessoa: usar peso original
nest = TRUE
)
pns2013Det <- pns2013[M001==1, ]
options( survey.lonely.psu = "adjust" )  # ??survey.lonely.psu
#Cria objeto de desenho da amostra
sample.pns13 <- svydesign(data = pns2013Det,
id = ~UPA_PNS, #PSU
strata = ~V0024, #Strat
weights=~V00291, #PesoPessoa: usar peso original
nest = TRUE
)
pns2013Det <- pns2013[M001==1, ]
summary(pns2013Det$V0029)
summary(pns2013$V0029)
pns2013[ !is.na(v4721)]
nrow( pns2013[ !is.na(v4721)] )
a <- pns2013[ !is.na(v4721)]
b <- pns2013[ is.na(v4721)]
summary(pns2013$E01602)
summary(pns2013$E01602)
summary(pns2013$E01604)
summary(pns2013$E01802)
summary(pns2013$E01804)
summary(pns2013$F00102)
summary(pns2013$F00702)
summary(pns2013$F00802)
summary(pns2013$VDF00102)
3 + 5 +6 + NA + 7
sum(4,5,6,7)
sum(4,5,6,7,na.rm=T)
sum(0,1,na.rm=T)
sum(0,na.rm=T)
a <- pns2013[ is.na(E01602) & is.na(E01604) & is.na(E01802) & is.na(E01804) & is.na(F00102) & is.na(F00702) & is.na(F00802) & is.na(VDF00102)]
a <- pns2013[ is.na(E01602) & is.na(E01604) & is.na(E01802) &
is.na(E01804) & is.na(F00102) & is.na(F00702) & is.na(F00802) & is.na(VDF00102)]
sum(NA, NA, NA)
sum(NA, NA, NA, na.rm=T)
pns2013[ C004 <17 , v4721 := sum( E01602, E01604, E01802, E01804, F00102, F00702, F00802, VDF00102, na.rm = T) / VDC001,
by= .(V0001, V0024, UPA_PNS, V0006_PNS)] # sum all income sources
summary(pns2013$v4721)
a <- pns2013[ !(is.na(E01602) & is.na(E01604) & is.na(E01802) &
is.na(E01804) & is.na(F00102) & is.na(F00702) & is.na(F00802) & is.na(VDF00102))]
a <- pns2013[ is.na(E01602) & is.na(E01604) & is.na(E01802) &
is.na(E01804) & is.na(F00102) & is.na(F00702) & is.na(F00802) & is.na(VDF00102)]
a <- pns2013[ !(is.na(E01602) & is.na(E01604) & is.na(E01802) &
is.na(E01804) & is.na(F00102) & is.na(F00702) & is.na(F00802) & is.na(VDF00102))]
205546-82268
a[ C004 <17 , v4721 := sum( E01602, E01604, E01802, E01804, F00102, F00702, F00802, VDF00102, na.rm = T) / VDC001,
by= .(V0001, V0024, UPA_PNS, V0006_PNS)] # sum all income sources
summary(a$v4721)
a <- pns2013[ is.na(E01602) & is.na(E01604) & is.na(E01802) &
is.na(E01804) & is.na(F00102) & is.na(F00702) & is.na(F00802) & is.na(VDF00102)]
a[ C004 <17 , v4721 := sum( E01602, E01604, E01802, E01804, F00102, F00702, F00802, VDF00102, na.rm = T) / VDC001,
by= .(V0001, V0024, UPA_PNS, V0006_PNS)] # sum all income sources
summary(pns2013$v4721)
a <- pns2013[ is.na(E01602) & is.na(E01604) & is.na(E01802) &
is.na(E01804) & is.na(F00102) & is.na(F00702) & is.na(F00802) & is.na(VDF00102)]
a[ C004 <17 , v4721 := sum( E01602, E01604, E01802, E01804, F00102, F00702, F00802, VDF00102, na.rm = T) / VDC001,
by= .(V0001, V0024, UPA_PNS, V0006_PNS)] # sum all income sources
summary(pns2013$v4721)
a <- pns2013[ is.na(E01602) & is.na(E01604) & is.na(E01802) &
is.na(E01804) & is.na(F00102) & is.na(F00702) & is.na(F00802) & is.na(VDF00102)]
a[ C004 <17 , v4721 := sum( E01602, E01604, E01802, E01804, F00102, F00702, F00802, VDF00102, na.rm = T) / VDC001,
by= .(V0001, V0024, UPA_PNS, V0006_PNS)] # sum all income sources
summary(pns2013$v4721)
a[ , v4721 := NULL]
a <- pns2013[ is.na(E01602) & is.na(E01604) & is.na(E01802) &
is.na(E01804) & is.na(F00102) & is.na(F00702) & is.na(F00802) & is.na(VDF00102)]
summary(pns2013$v4721)
summary(a$v4721)
a[, v4721 := NULL]
summary(a$v4721)
a[ C004 <17 , v4721 := sum( E01602, E01604, E01802, E01804, F00102, F00702, F00802, VDF00102, na.rm = T) / VDC001,
by= .(V0001, V0024, UPA_PNS, V0006_PNS)] # sum all income sources
summary(a$v4721)
a <- pns2013[ !(is.na(E01602) & is.na(E01604) & is.na(E01802) &
is.na(E01804) & is.na(F00102) & is.na(F00702) & is.na(F00802) & is.na(VDF00102))]
a[ C004 <17 , v4721 := sum( E01602, E01604, E01802, E01804, F00102, F00702, F00802, VDF00102, na.rm = T) / VDC001,
by= .(V0001, V0024, UPA_PNS, V0006_PNS)] # sum all income sources
a[, v4721 := NULL]
a[ C004 <17 , v4721 := sum( E01602, E01604, E01802, E01804, F00102, F00702, F00802, VDF00102, na.rm = T) / VDC001,
by= .(V0001, V0024, UPA_PNS, V0006_PNS)] # sum all income sources
summary(a$v4721)
summary(pns2013$E01602)
summary(pns2013$E01604)
summary(pns2013$E01802)
summary(pns2013$E01804)
summary(pns2013$F00102)
summary(pns2013$F00702)
summary(pns2013$F00802)
summary(pns2013$VDF00102)
a <- pns2013[  VDF00102==NA]
a <- pns2013[  is.na(VDF00102)]
load('./data/pnad08.18y.design.rda')
load('./data/pns13.18y.design.rda')
load('./data/pnad08.18y.design.rda')
load('./data/pns13.18y.design.rda')
svyquantile(~v4721, sample.pns13.pos, quantile=c(0.25,0.5,0.75), na.rm=T)
svyquantile(~v4721, pns13.18y.design, quantile=c(0.25,0.5,0.75), na.rm=T)
svymean(~v4721, pns13.18y.design, na.rm=T)
tab <- svytable(~v4721, sample.pns13.pos) %>% data.table()
tab <- svytable(~v4721, pns13.18y.design) %>% data.table()
tab
